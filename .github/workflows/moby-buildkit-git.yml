---
name: "moby-buildkit-git: Build and push container images"
'on':
  push:
#    branches:
#      - main
    paths:
      - ".github/workflows/moby-buildkit-git.yml"
#  schedule:
#    - cron: "10 1 * * *"
  workflow_dispatch:

jobs:
  build_push:
    name: Build and Push container images to quay.io
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Buildkit repository
        uses: actions/checkout@v2
        with:
          repository: moby/buildkit
          fetch-depth: 0
      - name: Calculate Docker image tags # Based on https://gist.github.com/sagikazarmark/0119e1f3dde0d8e755fd0ee5a5ef4cdc
        id: tags
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          VERSION=$(git describe --tags --long --exclude 'dockerfile/*' | sed 's/^v//;s/\([^-]*-g\)/r\1/;y/-/./')
          echo ::set-output name=version::${VERSION}
          echo ::set-output name=long_commit_hash::${COMMIT_SHA}
          echo ::set-output name=commit_hash::${COMMIT_SHA::8}
          echo ::set-output name=build_date::$(git show -s --format=%cI)
      - uses: docker/setup-qemu-action@v1
      - uses: docker/setup-buildx-action@v1
      - name: Login to quay.io
        uses: docker/login-action@v1
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}
      - name: Build and push image.
        uses: docker/build-push-action@v2
        with:
          context: ./
          platforms: linux/amd64,linux/arm/v7,linux/arm64,linux/ppc64le,linux/riscv64,linux/s390x
          push: true
          labels: |
            org.opencontainers.image.tite=Moby Buildkit from Git
            org.opencontainers.image.description=This is a rebuild of the docker.io/moby/buildkit image, but from the master branch of the upstream repository.
            org.opencontainers.image.url=https://quay.io/repository/gotmax23/moby-buildkit-git
            org.opencontainers.image.documentation=https://hub.docker.com/r/moby/buildkit
            org.opencontainers.image.source=https://github.com/moby/buildkit.git
            org.opencontainers.image.version=${{ steps.tags.outputs.version }}
            org.opencontainers.image.created=${{ steps.tags.outputs.build_date }}
            org.opencontainers.image.revision=${{ steps.tags.outputs.commit_hash }}
            org.opencontainers.image.licenses=Apache-2.0
            org.opencontainers.image.vendor=Maxwell G (@gotmax23)
          tags: |
            quay.io/gotmax23/moby-buildkit-git:latest
            quay.io/gotmax23/moby-buildkit-git:${{ steps.tags.outputs.commit_hash }}
            quay.io/gotmax23/moby-buildkit-git:${{ steps.tags.outputs.long_commit_hash }}
            quay.io/gotmax23/moby-buildkit-git:${{ steps.tags.outputs.version }}
